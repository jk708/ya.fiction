# Понятие сборки сайта

Основная черта БЭМ-проектов - удобство разработки. Структура БЭМ-сайта унифицирована, блоки легко искать и с ними легко работать.

Но что хорошо человеку - не всегда хорошо для робота, поэтому перед тем, как передать сайт браузеру, его следует *собрать*.

**Сборка сайта** - согласование взаимосвязей между сущностями и библиотеками, а также приведение кода к наиболее компактному виду.

Процесс сборки БЭМ-проекта можно настраивать в зависимости от текущих целей. Это позволяет на основе одного и того же набора блоков получить, к примеру, две функционально разные версии сайта: стандартную и для мобильных устройств.

# Инструменты сборки

Существует множество систем автоматической сборки и запуска задач, самые известные из которых:

* [Gulp](http://gulpjs.com/)
* [Grunt](http://gruntjs.com/)
* [Brunch](http://brunch.io/)
* [Broccoli](https://www.npmjs.org/package/broccoli)

При сборке сайта, созданного в предметной области [БЭМ](http://ru.bem.info/method/definitions/), возникает ряд специфических задач, с полным спектром которых справляются алгоритмы инструментов `bem-tools` и `ENB`:

* [ENB](http://enb-make.info/) - быстрый и гибко настраиваемый инструмент, хорошо зарекомендовавший себя в применении к БЭМ-проектам. Он предоставляет множество встроенных технологий сборки и позволяет внедрять собственные.

* [bem-tools](http://ru.bem.info/tools/bem/bem-tools/) - многофункциональный набор инструментов, созданный специально для работы с БЭМ-методологией.

Встроенный в `bem-tools` инструмент сборки отлично подходит для несложных проектов. Для более быстрого и кастомизированного процесса сборки мы рекомендуем `ENB`.

# Процесс сборки шаг за шагом

Рассмотрим пошагово, как собирается базовый БЭМ-проект, и отметим, как при этом расширяется файловая структура сайта:

![Структура project-stub](https://img-fotki.yandex.ru/get/5819/158800653.0/0_10fc2c_c301a191_orig)

Для понимания процесса сборки попробуйте самостоятельно собрать шаблонный проект `project-stub`. [Читайте подробнее](http://ru.bem.info/tutorials/start-with-project-stub/) о том, как клонировать и собрать проект, в разделе "Создание собственного репозитория проекта".

## Конфигурация сборки

Стандартное поведение сборщика можно перенастроить изменив конфигурационные файлы.

Расположенный в корневой папке `bower.json` позволяет подключать к проекту нужные библиотеки. Для этого нужно добавить имя и версию/адрес библиотеки в `dependencies`.

Конфигурационные файлы для сборки инструментарием `bem-tools` находятся в папке `.bem`:

* `.bem/level.js` задаёт подключаемые уровни переопределения для блоков;
* `.bem/make.js` переопределяет ключевые узлы сборки ([подробнее](http://ru.bem.info/tools/bem/bem-tools/customization/)).

Сборщику `enb` соответствует конфигурационный файл `.enb/make.js`.

## Стандартная схема сборки БЭМ-проекта

**На входе:** структура сайта удобна и логична для разработчика.

**В процессе:** учитываем все зависимости сущностей, отбрасываем всё лишнее.

**На выходе:** получаем скомпилированный и оптимизированный набор файлов, оптимальный для передачи на обработку браузеру.

На основе исходного `*.bemjson.js` для каждого бандла в процессе сборки создаются следующие файлы: 

![Общая схема сборки](http://img-fotki.yandex.ru/get/6837/158800653.0/0_10741c_bfcdd557_orig)

# Запуск сборки

В `ENB` и `bem-tools` можно собрать проект в одном из следующих режимов:
* Сборка проекта целиком в файловой системе;
* Сборка в режиме сервера, при запуске обрабатываются только изменённые файлы. Промежуточный результат доступен в браузере.

## От bemjson.js к bemdecl.js

Основой процесса сборки каждого бандла является файл `<имя_бандла>.bemjson.js>`: в нём содержится дерево всех сущностей, реализации которых необходимо собрать (помимо шаблонов, которые подключаются отдельно, согласно зависимостям).

Определившись с инструментом автоматизации и режимом сборки, запускаем процесс, который автоматически преодолевает несколько стадий генерации файлов.

На первом этапе сборки дерево сущностей трансформируется в компактный список блоков, элементов и модификаторов: без повторяющихся участков, без учёта вложенности, но с сохранением порядка их декларации. Полученный список сохраняется в файл `<имя_бандла>.bemdecl.js`.

## От bemdecl.js к deps.js

Файл `<имя_бандла>.deps.js` создаётся на основе декларации `<имя_бандла>.bemdecl.js` и конфигурационных файлов сборки. Он представляет собой упорядоченный массив, описывающий зависимость сущностей бандла от других сущностей и от технологий. При генерации файла учитывается, какие библиотеки были включены в сборку в `bower.json`.

## От deps.js к файлам технологий

На финальном этапе, согласно `<имя_бандла>.deps.js`, генерируются файлы технологий (`<имя_бандла>.html`, `<имя_бандла>.css` и т.д.). Каждый файл технологии включает в себя все правила, касающиеся сущностей данного бандла, в рамках конкретной технологии. Эти оптимизированные файлы несут в себе всю информацию о проекте, но представляют её в том виде, который максимально корректно и быстро воспринимается роботом.

Итоговые файлы могут быть выложены на сервер: собранный проект занимает меньше места, а его структура способствует снижению количества запросов.
