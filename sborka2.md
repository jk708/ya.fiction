# Понятие сборки сайта

Основная черта БЭМ-проектов - удобство разработки. Структура БЭМ-сайта унифицирована, блоки легко искать и с ними легко работать.

Но что хорошо человеку - не всегда хорошо для робота, поэтому перед тем, как передать сайт браузеру, его следует *собрать*.

**Сборка сайта** - согласование взаимосвязей между сущностями и библиотеками, а также приведение кода к наиболее компактному виду.

Процесс сборки БЭМ-проекта можно настраивать в зависимости от текущих целей, что позволяет на основе одного и того же набора блоков получить, например, две функционально разные версии сайта: стандартную и для мобильных устройств.

# Инструменты сборки

Существует множество систем автоматической сборки и запуска задач, самые известные из которых:

* [Gulp](http://gulpjs.com/)
* [Grunt](http://gruntjs.com/)
* [Brunch](http://brunch.io/)
* [Broccoli](https://www.npmjs.org/package/broccoli)

При сборке сайта, созданного в предметной области [БЭМ](http://ru.bem.info/method/definitions/), возникает ряд специфических задач, с полным спектром которых справляются алгоритмы модулей `bem-tools` и `enb`.

## Сборка с bem-tools

Набор инструментов [bem-tools](http://ru.bem.info/tools/bem/bem-tools/) имеет в своём арсенале две команды, соответствующие двум режимам сборки:

* `bem make` - собирает проект целиком на файловой системе;
* `bem server` - при запуске обрабатывает только изменённые файлы, позволяет просмотреть итоговый проект в браузере, на TCP 8080.
**NB**: Порт можно поменять с помощью ключа `--port (-p)`.

При использовании `bem-tools`, итоговые файлы оптимизируются с помощью [borschik](http://ru.bem.info/tools/optimizers/borschik/). По умолчанию, для листов стилей используется [Clean CSS](http://cleancss.com/), а для скриптов и разметки - [UglifyJS](https://github.com/mishoo/UglifyJS), однако разработчик имеет возможность предварительно переопределить инструменты оптимизации. 

## Сборка с enb

На данный момент предпочтительной альтернативой `bem-tools` является сборщик проектов [enb](http://enb-make.info/). Он работает быстрее и предоставляет более гибкий контроль процесса сборки, однако его сложнее настроить.

# Сборка на практике

Рассмотрим пошагово, как собирается примитивный БЭМ-проект, и, по факту, расширяется файловая структура сайта:

![Структура project-stub](https://img-fotki.yandex.ru/get/5819/158800653.0/0_10fc2c_c301a191_orig)

В качестве иллюстрации структуры и содержания файлов рекомендуется рассмотреть шаблонный проект `project-stub`. [Читайте подробнее](http://ru.bem.info/tutorials/start-with-project-stub/) о том, как клонировать и собрать проект, в разделе "Создание собственного репозитория проекта".

## Конфигурация сборки

Изменив конфигурационные файлы, можно переопределить стандартное поведение сборщика.

Расположенный в корневой папке `bower.json` позволяет подключать к проекту нужные библиотеки. Для этого нужно добавить имя и версию/адрес библиотеки в `dependencies`.

Конфигурационные файлы для сборки инструментарием `bem-tools` находятся в папке `.bem`:

* `.bem/level.js` задаёт подключаемые уровни переопределения для блоков;
* `.bem/make.js` переопределяет ключевые узлы сборки ([подробнее](http://ru.bem.info/tools/bem/bem-tools/customization/)).

Сборщику `enb` соответствует конфигурационный файл `.enb/make.js`.

## Стандартная схема сборки БЭМ-проекта

**На входе:** имеем структуру, которая наглядна для разработчика, – библиотеки БЭМ и JavaScript-декларации бандлов ([подробнее](http://ru.bem.info/tools/bem/bem-tools/tech-modules/) об особенностях архитектуры).

**В процессе:** учитываем все зависимости сущностей, отбрасываем всё лишнее.

**На выходе:** получаем скомпилированный и оптимизированный набор файлов, идеальный для передачи на обработку браузеру.

На основе исходного `*.bemjson.js` для каждого бандла в процессе сборки создаются следующие файлы: 

![Общая схема сборки](http://img-fotki.yandex.ru/get/6837/158800653.0/0_10741c_bfcdd557_orig)

## От bemjson.js к bemdecl.js

Основой процесса сборки каждого бандла является файл `<имя_бандла>.bemjson.js>`: в нём содержится дерево всех сущностей, реализации которых необходимо собрать.

Определившись с инструментом автоматизации и режимом сборки, запускаем процесс, который автоматически преодолевает несколько стадий генерации файлов.

На первом этапе сборки дерево сущностей трансформируется в компактный список блоков, элементов и модификаторов: без повторяющихся участков, без учёта вложенности, но с сохранением порядка их декларации. Полученный список сохраняется в файл `<имя_бандла>.bemdecl.js`.

## От bemdecl.js к deps.js

Файл `<имя_бандла>.deps.js` создаётся на основе декларации `<имя_бандла>.bemdecl.js` и конфигурационных файлов сборки. Он представляет собой упорядоченный массив, описывающий зависимость сущностей бандла от других сущностей и от технологий. При генерации файла учитывается, какие библиотеки были включены в сборку в `bower.json`.

## От deps.js к файлам технологий

На финальном этапе, согласно `<имя_бандла>.deps.js`, генерируются файлы технологий (`<имя_бандла>.html`, `<имя_бандла>.css` и т.д.). Каждый файл технологии включает в себя все правила, касающиеся сущностей данного бандла, в рамках конкретной технологии. Эти оптимизированные файлы несут в себе всю информацию о проекте, но представляют её в том виде, который максимально корректно и быстро воспринимается роботом.

Итоговые файлы могут быть выложены на сервер: собранный проект занимает меньше места, а его структура способствует снижению количества запросов.
