# Понятие сборки сайта

Большинство современных сайтов построены на основе шаблонов, что делает структуру сайта по-настоящему динамической и позволяет использовать отдельные блоки многократно, снижая количество запросов на сервер.

Принимая решение логически разбить сайт на множество взаимозависимых сущностей, разработчик получает инструментарий для ювелирной работы с веб-страницами. При этом становится актуальным понятие сборки сайта – согласования всех взаимосвязей и приведения кода к наиболее компактному виду.

Существует множество систем автоматической сборки и запуска задач, самые известные из которых:

* [Gulp](http://gulpjs.com/)
* [Grunt](http://gruntjs.com/)
* [Brunch](http://brunch.io/)
* [Broccoli](https://www.npmjs.org/package/broccoli)

При сборке сайта, созданного в предметной области [БЭМ](http://ru.bem.info/method/definitions/), возникает ряд специфических задач, с полным спектром которых справляются алгоритмы модулей [bem-tools](http://ru.bem.info/tools/bem/bem-tools/) и [enb](http://enb-make.info/). 

Параметры сборки БЭМ-проекта могут быть определены различным образом, в зависимости от целей. К примеру, на основе одного и того же набора блоков легко получить две функционально разные версии сайта: стандартную и для мобильных устройств. Путём подключения тех или иных доступных функциональностей обеспечивается вариативность и гибкость настройки.

# Общая схема сборки БЭМ-проекта

**На входе:** имеем структуру, которая наглядна для разработчика, – библиотеки БЭМ и JavaScript-декларации бандлов ([подробнее](http://ru.bem.info/tools/bem/bem-tools/tech-modules/) об особенностях архитектуры).

**В процессе:** учитываем все зависимости сущностей, отбрасываем всё лишнее.

**На выходе:** получаем скомпилированный и оптимизированный набор файлов, идеальный для передачи на обработку браузеру.

На основе исходного <i>*.bemjson.js</i> для каждого бандла в процессе сборки создаются следующие файлы: 

![Общая схема сборки](http://img-fotki.yandex.ru/get/14/158800653.0/0_10234d_e3fd5b72_orig)

# Сборка на практике

Для начала убедимся, что у нас имеются файлы конфигурации сборки:

*	**bower.json** - *декларация используемых библиотек* ([пример кода](https://gist.github.com/jk708/52fd36266d26f48ed080))

* **.bem/make.js** - *декларация используемых технологий и уровней библиотек* ([пример кода](https://gist.github.com/jk708/7d23d827466dc010b08a))

Разработчик может выбрать, какие технологии и какие уровни библиотек подключать, на основании чего впоследствии будет составлен файл с зависимостями сущностей - <i>*.deps.js</i>.

Отметим, что перед первой сборкой в каждом бандле хранится лишь один файл – *<имя_бандла>.bemjson.js*. Это описание всех блоков, элементов и модификаторов, используемых для реализации данного бандла, в формате JavaScript.

Определимся, какую команду использовать для сборки:

* `$ bem make` при запуске пересобирает проект полностью, сохраняя его локальную копию

* `$ bem server` при запуске обрабатывает только изменённые файлы, позволяет просмотреть итоговый проект в браузере, на TCP 8080

Сразу после применения команды начинается первый этап сборки: на основе стандартной JavaScript-декларации бандла создаётся файл декларации в специфическом БЭМ-формате - <i>*.bemdecl.js</i>. За счёт устранения повторяющихся отрезков кода уменьшается итоговый объём списка, который в оптимальной форме перечисляет используемые блоки, элементы и модификаторы. 

На втором этапе создаётся файл <i>*.deps.js</i> - упорядоченный массив, описывающий зависимость сущностей бандла от других сущностей и от технологий. При этом учитывается заранее заданная конфигурация используемых и игнорируемых библиотек.

Финальный этап – генерация отдельных файлов для технологий, каждый из которых представляет собой совокупность всех правил, касающихся сущностей данного бандла, в рамках конкретной технологии. Итоговые файлы оптимизируются с помощью [borschik](http://ru.bem.info/tools/optimizers/borschik/). По умолчанию, для листов стилей используется [Clean CSS](http://cleancss.com/), а для скриптов и разметки - [UglifyJS](https://github.com/mishoo/UglifyJS), однако разработчик имеет возможность предварительно переопределить инструменты оптимизации. 

Описанный процесс происходит автоматически, после его завершения в папках бандлов появляется основной результат сборки БЭМ-проекта – оптимизированные файлы технологий. С помощью одной команды из множества разрозненных блоков, которыми было удобно оперировать при написании кода, собираются сжатые и цельные конструкции оптимизированных данных.
